<!-- Rest des Codes bleibt gleich, nur die relevanten JavaScript-Teile werden hier gezeigt -->

<script>
    // DOM-Elemente und andere Variablen...

    // Funktion zum Aufrufen der Eleven Labs API über Backend-Proxy
    async function speakWithElevenLabs(text, voiceId = "NLdsrIcUBS4NcgKkzSzj") { // Nicole (Deutsch)
        try {
            // Status aktualisieren
            if (audioStatus) {
                audioStatus.textContent = "Eleven Labs API wird angerufen...";
            }
            
            // Unseren Backend-Proxy statt direkt die Eleven Labs API aufrufen
            const response = await fetch('/elevenlabs_tts', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    text: text,
                    voice_id: voiceId
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(`Eleven Labs API error: ${response.status} ${errorData ? JSON.stringify(errorData) : ''}`);
            }

            // Audio-Daten als arrayBuffer erhalten
            const audioData = await response.arrayBuffer();
            
            // Blob und URL für das Audio erstellen
            const audioBlob = new Blob([audioData], { type: "audio/mpeg" });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // Audio-Element erstellen und abspielen
            const audioElement = new Audio(audioUrl);
            
            // Event-Listener hinzufügen
            audioElement.onplay = () => {
                console.log("Eleven Labs audio started playing");
                if (audioStatus) audioStatus.textContent = "Sprachausgabe läuft (Eleven Labs)...";
            };
            
            audioElement.onended = () => {
                console.log("Eleven Labs audio finished playing");
                if (audioStatus) audioStatus.textContent = "Sprachausgabe abgeschlossen.";
                // URL-Objekt freigeben
                URL.revokeObjectURL(audioUrl);
            };
            
            audioElement.onerror = (e) => {
                console.error("Error playing Eleven Labs audio:", e);
                if (audioStatus) audioStatus.textContent = "Fehler bei der Wiedergabe: " + e.message;
                URL.revokeObjectURL(audioUrl);
            };

            // Audio-Element in einer globalen Variable speichern für potenzielle Stornierung
            window.currentAudioElement = audioElement;
            
            // Audio abspielen
            audioElement.play();
            
            return true; // Erfolg
        } catch (error) {
            console.error("Eleven Labs API error:", error);
            if (audioStatus) audioStatus.textContent = "Eleven Labs API Fehler: " + error.message;
            return false; // Fehlgeschlagen
        }
    }

    // Verbesserte speakText-Funktion, die zuerst Eleven Labs versucht
    async function speakText(text, rate) {
        // Aktuelle Audio-Wiedergabe abbrechen
        if (window.currentAudioElement) {
            window.currentAudioElement.pause();
            window.currentAudioElement = null;
        }
        
        // ResponsiveVoice abbrechen, falls es spielt
        if (typeof responsiveVoice !== 'undefined' && responsiveVoice.isPlaying()) {
            responsiveVoice.cancel();
        }
        
        // Status aktualisieren
        if (audioStatus) {
            audioStatus.textContent = "Sprachausgabe wird vorbereitet...";
        }
        
        // Für deutschen Text eine deutsche Stimme-ID verwenden
        // Nicole - deutsche Stimme
        const germanVoiceId = "NLdsrIcUBS4NcgKkzSzj";
        
        // Zuerst Eleven Labs versuchen
        const elevenLabsSuccess = await speakWithElevenLabs(text, germanVoiceId);
        
        // Wenn Eleven Labs fehlschlägt, auf ResponsiveVoice zurückfallen
        if (!elevenLabsSuccess) {
            console.log("Falling back to ResponsiveVoice");
            if (audioStatus) audioStatus.textContent = "Eleven Labs fehlgeschlagen, verwende ResponsiveVoice...";
            
            // Prüfen, ob ResponsiveVoice verfügbar ist
            if (typeof responsiveVoice === 'undefined') {
                console.error("ResponsiveVoice ist nicht verfügbar - Bibliothek nicht geladen");
                if (audioStatus) audioStatus.textContent = "Fehler: Sprachausgabe nicht verfügbar. Bitte Seite neu laden.";
                return;
            }
            
            // Sicherstellen, dass ResponsiveVoice initialisiert ist
            if (!responsiveVoice.isInitialised()) {
                console.log("ResponsiveVoice wird initialisiert...");
                responsiveVoice.init();
            }
            
            // Voice-Optionen
            const voiceOptions = {
                rate: rate || 1.0,
                pitch: 1,
                volume: 1,
                onstart: function() {
                    console.log("ResponsiveVoice gestartet");
                    if (audioStatus) audioStatus.textContent = "Sprachausgabe läuft (ResponsiveVoice)...";
                },
                onend: function() {
                    console.log("ResponsiveVoice beendet");
                    if (audioStatus) audioStatus.textContent = "Sprachausgabe abgeschlossen.";
                },
                onerror: function(e) {
                    console.error("ResponsiveVoice Fehler:", e);
                    if (audioStatus) audioStatus.textContent = "ResponsiveVoice Fehler: " + e;
                }
            };
            
            // Die beste verfügbare deutsche Stimme verwenden
            const bestVoice = getBestGermanVoice();
            responsiveVoice.speak(text, bestVoice, voiceOptions);
        }
    }

    // Rest der Funktionen...
</script>

<!-- ResponsiveVoice Script korrekt vor dem schließenden </body> Tag platzieren -->
<script src="https://code.responsivevoice.org/responsivevoice.js?key=0qee8GKV"></script>
<script>
    // Funktion, die nach dem Laden von ResponsiveVoice ausgeführt werden soll
    if (typeof responsiveVoice !== 'undefined') {
        console.log("ResponsiveVoice wurde geladen!");
        
        // Audio-Kontext für Mobile entsperren beim ersten Laden
        try {
            if (responsiveVoice.clickEvent) {
                responsiveVoice.clickEvent();
            }
            
            // Verfügbare Stimmen anzeigen
            if (responsiveVoice.getVoices) {
                console.log("Verfügbare Stimmen beim Laden:", responsiveVoice.getVoices().map(v => v.name));
            }
        } catch (e) {
            console.error("Fehler beim initialen ResponsiveVoice Setup:", e);
        }
    }
</script>
